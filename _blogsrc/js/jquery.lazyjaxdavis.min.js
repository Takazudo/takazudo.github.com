/*! jQuery.LazyJaxDavis - v0.1.1 -  4/6/2012
 * https://github.com/Takazudo/jQuery.LazyJaxDavix
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */(function(){var a=Array.prototype.slice,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};(function(b,d,e){var f,g,h,i,j;return i={},f=b(e),j=i.wait=function(a){return b.Deferred(function(b){return setTimeout(function(){return b.resolve()},a)})},b.support.pushstate=b.isFunction(d.history.pushState),i.isToId=function(a){return a.charAt(0)==="#"?!0:!1},i.trimGetVals=function(a){return a.replace(/\?.*/,"")},i.tryParseAnotherPageAnchor=function(a){var b,c;return i.isToId(a)?!1:a.indexOf("#")===-1?!1:(b=a.match(/^([^#]+)#(.+)/),c={path:b[1]},b[2]&&(c.hash="#"+b[2]),c)},i.filterStr=function(a,c){var d;return d=a.match(c),d&&d[1]?b.trim(d[1]):null},i.logger=d.Davis?(new Davis.logger).logger:null,i.info=h=function(a){if(!i.logger)return;return i.logger.info(a)},i.error=g=function(a){if(!i.logger)return;return i.logger.error(a)},i.fetchPage=function(){var a;return a=null,function(c,d){var e;return e=b.Deferred(function(e){return a&&a.abort(),d=b.extend({url:c},d),a=b.ajax(d).then(function(b){return a=null,e.resolve(b)},function(a,b){var c;return c=b==="abort",e.reject(c)})}).promise(),e.abort=function(){return a!=null?a.abort():void 0},e}}(),i.Event=function(){function b(){this._callbacks={}}return b.prototype.bind=function(a,b){var c,d,e,f,g;c=a.split(" ");for(f=0,g=c.length;f<g;f++)d=c[f],(e=this._callbacks)[d]||(e[d]=[]),this._callbacks[d].push(b);return this},b.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},b.prototype.trigger=function(){var b,c,d,e,f,g,h;b=1<=arguments.length?a.call(arguments,0):[],d=b.shift(),e=(h=this._callbacks)!=null?h[d]:void 0;if(!e)return;for(f=0,g=e.length;f<g;f++){c=e[f];if(c.apply(this,b)===!1)break}return this},b.prototype.unbind=function(a,b){var c,d,e,f,g;if(!a)return this._callbacks={},this;e=(g=this._callbacks)!=null?g[a]:void 0;if(!e)return this;if(!b)return delete this._callbacks[a],this;for(d=0,f=e.length;d<f;d++){c=e[d];if(c!==b)continue;e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},b}(),i.HistoryLogger=function(){function a(){this._items=[],this._items.push(location.pathname.replace(/#.*/,""))}return a.prototype.push=function(a){return this._items.push(a),this},a.prototype.last=function(){var a;return a=this._items.length,a?this._items[a-1]:null},a.prototype.isToSamePageRequst=function(a){var b;return b=this.last(),b?a===b?!0:!1:!1},a.prototype.size=function(){return this._items.length},a}(),i.Page=function(a){function j(a,c,d,e,f,g){var i,k,l,m=this;this.request=a,this.routed=d,this.router=e,this.hash=g,j.__super__.constructor.apply(this,arguments),this.config=b.extend({},this.config,c),this.options=b.extend(!0,{},this.options,f),b.type(this.config.path)==="string"?this.path=this.config.path:this.path=this.request.path,b.each(h,function(a,c){return b.each(m.config,function(a,b){return c!==a?!0:m.bind(c,b)})}),i=((k=this.config)!=null?k.anchorhandler:void 0)||((l=this.options)!=null?l.anchorhandler:void 0),i&&(this._anchorhandler=i),this.bind("pageready",function(){if(!m.hash)return;return m._anchorhandler.call(m,m.hash)})}var h;return c(j,a),h=["fetchstart","fetchsuccess","fetchabort","fetchfail","pageready","anchorhandler"],j.prototype.options={ajxoptions:{dataType:"text",cache:!0},expr:null,updatetitle:!0,title:null},j.prototype.router=null,j.prototype.config=null,j.prototype._text=null,j.prototype._anchorhandler=function(a){var b;return a?(b=f.find(a).offset().top,d.scrollTo(0,b),this):this},j.prototype.fetch=function(){var a,c,d,e,f,g,h=this;a=null,d=this.request.path,c=((e=this.options)!=null?e.ajaxoptions:void 0)||{};if((f=this.config)!=null?f.method:void 0)c.type=this.config.method;if((g=this.request)!=null?g.params:void 0)c.data=b.extend(!0,{},c.data,this.request.params);return this._fetchDefer=b.Deferred(function(b){return a=i.fetchPage(d,c).then(function(a){return h._text=a,h.updatetitle(),b.resolve()},function(a){return b.reject({aborted:a})}).always(function(){return h._fetchDefer=null})}),this._fetchDefer.abort=function(){return a.abort()},this._fetchDefer},j.prototype.abort=function(){var a;return(a=this._fetchDefer)!=null&&a.abort(),this},j.prototype.rip=function(a){var b,c,d,e;return this._text?a?(b=(d=this.options)!=null?(e=d.expr)!=null?e[a]:void 0:void 0,b?(c=i.filterStr(this._text,b),c||g("ripper could not find the text for key: "+a),c):null):this._text:null},j.prototype.updatetitle=function(){var a;return this.options.updatetitle?(a=null,!a&&this._text&&(a=this.rip("title")),a?(e.title=a,this):this):this},j}(i.Event),i.Router=function(d){function e(a){if(!(this instanceof arguments.callee))return new i.Router(a);e.__super__.constructor.apply(this,arguments),this.history=new i.HistoryLogger,a.call(this,this),this.options.davis&&this._setupDavis(),this.firePageready(!this.options.firereadyonstart),this.fireTransPageready()}return c(e,d),e.prototype.options={ajaxoptions:{dataType:"text",cache:!0,type:"GET"},expr:{title:/<title[^>]*>([^<]*)<\/title>/,content:/<!-- LazyJaxDavis start -->([\s\S]*)<!-- LazyJaxDavis end -->/},davis:{linkSelector:"a:not([href^=#]):not(.apply-nolazy)",formSelector:"form:not(.apply-nolazy)",throwErrors:!1,handleRouteNotFound:!0},minwaittime:0,updatetitle:!0,firereadyonstart:!0,ignoregetvals:!1},e.prototype._createPage=function(a,b,c,d){var e,f;return e={expr:this.options.expr,updatetitle:this.options.updatetitle},this.options.anchorhandler&&(e.anchorhandler=this.options.anchorhandler),(b!=null?b.ajaxoptions:void 0)?e.ajaxoptions=b.ajaxoptions:this.options.ajaxoptions&&(e.ajaxoptions=this.options.ajaxoptions),!d&&(a!=null?a.path:void 0)&&(f=i.tryParseAnotherPageAnchor(a.path),d=f.hash||null),new i.Page(a,b,c,this,e,d)},e.prototype._setupDavis=function(){var a,c,d=this;if(!b.support.pushstate)return;return c=this,a=function(a){return a.bind("pageready",function(){return c._findWhosePathMatches("page",a.path),c.trigger("everypageready"),c.fireTransPageready()}),c.history.push(a.path),c.fetch(a)},this.davis=new Davis(function(){var d,e;return d=this,c.pages&&b.each(c.pages,function(e,f){var g;if(b.type(f.path)==="regexp")return;return g=(f.method||"get").toLowerCase(),d[g](f.path,function(b){var d;if(c.history.isToSamePageRequst(b.path))return;return d=c._createPage(b,f,!0),a(d)}),!0}),(e=c.davisInitializer)!=null?e.call(d):void 0}),this.options.davis.handleRouteNotFound&&this.davis.bind("routeNotFound",function(b){var d,e,f,g,h,j;if(i.isToId(b.path)){c.trigger("toid",b.path);return}h=i.tryParseAnotherPageAnchor(b.path),e=h.hash||null,g=h.path||b.path;if(c.history.isToSamePageRequst(g))return;return d=c._findWhosePathMatches("page",g)||null,j=d?!0:!1,f=c._createPage(b,d,j,e),a(f)}),this.davis.configure(function(a){return b.each(d.options.davis,function(b,c){return a[b]=c,!0})}),this._tweakDavis(),this},e.prototype._tweakDavis=function(){var b,c=this;return b=this.davis.logger.warn,h=this.davis.logger.info,this.davis.logger.warn=function(){var d;return d=1<=arguments.length?a.call(arguments,0):[],d[0].indexOf("routeNotFound")!==-1?(d[0]=d[0].replace(/routeNotFound/,"unRouted"),h.apply(c.davis.logger,d)):b.apply(c.davis.logger,d)},this},e.prototype._findWhosePathMatches=function(a,c,d){var e,f,h,j=this;if(a==="page"){if(!this.pages||!this.pages.length)return null;e=this.pages}else if(a==="transRoutes"){if(!this.transRoutes||!this.transRoutes.length)return null;e=this.transRoutes,d=!0}return f=[],h=i.trimGetVals(c),b.each(e,function(a,e){var g;j.options.ignoregetvals||e.ignoregetvals?g=h:g=c;if(b.type(e.path)==="regexp"){if(!e.path.test(g))return!0;f.push(e);if(d)return!0}if(e.path===g){f.push(e);if(d)return!0}return!0}),!d&&f.length>1?(g("2 or more expr was matched about: "+c),b.each(f,function(a,b){return g("dumps detected page configs - path:"+b.path)}),!1):d?f:f[0]||null},e.prototype.fetch=function(a){var c=this;return b.Deferred(function(d){return a.trigger("fetchstart",a),c.trigger("everyfetchstart",a),b.when(a.fetch(),j(c.options.minwaittime)).then(function(){return a.trigger("fetchsuccess",a),c.trigger("everyfetchsuccess",a),d.resolve()},function(b){return b.aborted?(a.trigger("fetchabort",a),c.trigger("everyfetchabort",a)):(a.trigger("fetchfil",a),c.trigger("everyfetchfail",a))})}).promise()},e.prototype.stop=function(){var a;return(a=this.davis)!=null&&a.stop(),this},e.prototype.navigate=function(a,b){var c;return this.davis?(c=new Davis.Request({method:b||"get",fullPath:a,title:""}),Davis.location.assign(c)):location.href=a,this},e.prototype.firePageready=function(a){var b,c;if((c=this.pages)!=null?c.length:void 0)b=this._findWhosePathMatches("page",location.pathname),b&&typeof b.pageready=="function"&&b.pageready();return a?this:(this.trigger("everypageready"),this)},e.prototype.fireTransPageready=function(){var a,c;if((c=this.transRoutes)!=null?c.length:void 0){a=this._findWhosePathMatches("transRoutes",location.pathname);if(!a.length)return this;b.each(a,function(a,b){return typeof b.pageready=="function"?b.pageready():void 0})}return this},e.prototype.route=function(a){return this.pages=a,this},e.prototype.routeTransparents=function(a){return this.transRoutes=a,this},e.prototype.routeDavis=function(a){return this.davisInitializer=a,this},e.prototype.option=function(a){return a?this.options=b.extend(!0,{},this.options,a):this.options},e}(i.Event),b.LazyJaxDavisNs=i,b.LazyJaxDavis=i.Router})(jQuery,this,this.document)}).call(this);